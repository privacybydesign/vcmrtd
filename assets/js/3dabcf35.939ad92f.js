"use strict";(self.webpackChunkdmrtd_docs=self.webpackChunkdmrtd_docs||[]).push([[1516],{906:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/CSCA-89eadb30d194607250992498f462d574.png"},7599:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"info/pki","title":"PKI","description":"CSCA PKI infrastructure","source":"@site/docs/info/pki.md","sourceDirName":"info","slug":"/info/pki","permalink":"/dmrtd/info/pki","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"docSidebar","previous":{"title":"Passport Standards","permalink":"/dmrtd/info/standards"}}');var s=t(4848),r=t(8453);const c={},l="PKI",d={},o=[{value:"Download Masterlists",id:"download-masterlists",level:2},{value:"Loads the EF.SOD into ASN1parser.",id:"loads-the-efsod-into-asn1parser",level:2},{value:"Strip application tag",id:"strip-application-tag",level:2},{value:"Extract the Document Signer Certificate",id:"extract-the-document-signer-certificate",level:2},{value:"Convert the Document Signer Certificate to a CER file",id:"convert-the-document-signer-certificate-to-a-cer-file",level:2},{value:"Get the CSCA&#39;s",id:"get-the-cscas",level:2},{value:"Extract signed content",id:"extract-signed-content",level:2},{value:"Verify EF.SOD signature",id:"verify-efsod-signature",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"pki",children:"PKI"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"CSCA PKI infrastructure",src:t(906).A+"",width:"871",height:"711"})}),"\n",(0,s.jsx)(n.h2,{id:"download-masterlists",children:"Download Masterlists"}),"\n",(0,s.jsxs)(n.p,{children:["We will first experiment with the Dutch Masterlist, which can be found here: ",(0,s.jsx)(n.a,{href:"https://www.npkd.nl/index.html",children:"https://www.npkd.nl/index.html"}),"\r\nThe reason that we experiment with this is because the Governance of the ICAO lists is questionable. This is reflected in the absence of for instance the USA root certificates"]}),"\n",(0,s.jsx)(n.p,{children:"You need to download the following files"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Masterlist.mls which contains 394 certificates of a 120 countries and is signed by the Dutch Government."}),"\n",(0,s.jsx)(n.li,{children:"The Self signed certificate."}),"\n",(0,s.jsx)(n.li,{children:"The latest Link Certificate."}),"\n"]}),"\n",(0,s.jsx)(n.h1,{id:"validating-efsod",children:"Validating EF.SOD"}),"\n",(0,s.jsxs)(n.p,{children:["The goal is to extract the Document Signer Certificate and validate the ",(0,s.jsx)(n.code,{children:"EF.SOD"})," against the CSCA master list."]}),"\n",(0,s.jsx)(n.h2,{id:"loads-the-efsod-into-asn1parser",children:"Loads the EF.SOD into ASN1parser."}),"\n",(0,s.jsxs)(n.p,{children:["Read the ",(0,s.jsx)(n.code,{children:"EF.SOD"})," section from the Passport."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final hex = mrtdData.sod!.toBytes().hex();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Load the ",(0,s.jsx)(n.code,{children:"hex"})," into ",(0,s.jsx)(n.code,{children:"https://lapo.it/asn1js"})," to explore the ASN1 structure."]}),"\n",(0,s.jsxs)(n.p,{children:["The hex dump form Dart can be put into a txt file.\r\n",(0,s.jsx)(n.code,{children:"echo hexstring > sod.txt"})]}),"\n",(0,s.jsxs)(n.p,{children:["Then it be converted to binary format using ",(0,s.jsx)(n.code,{children:"xxd -r -p sod.txt > EF.SOD"})]}),"\n",(0,s.jsxs)(n.p,{children:["Then the file can be parsed using ",(0,s.jsx)(n.code,{children:"openssl asn1parse -in EF.SOD -inform DER -i"})]}),"\n",(0,s.jsx)(n.h2,{id:"strip-application-tag",children:"Strip application tag"}),"\n",(0,s.jsx)(n.p,{children:"The actual CMS ContentInfo (which OpenSSL expects to start with a SEQUENCE) begins at byte offset 4.\r\nManually strip the outer [APPLICATION 23] tag"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"0:d=0  hl=4 l=2659 cons: appl [ 23 ]\r\n4:d=1  hl=4 l=2655 cons:  SEQUENCE\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"dd if=EF.SOD of=EF.SOD.cms bs=1 skip=4"})}),"\n",(0,s.jsx)(n.h2,{id:"extract-the-document-signer-certificate",children:"Extract the Document Signer Certificate"}),"\n",(0,s.jsx)(n.p,{children:"openssl cms -inform DER -in EF.SOD.cms -verify -noverify -out /dev/null -certsout dsc.pem\r\nopenssl x509 -in dsc.pem -text -noout"}),"\n",(0,s.jsx)(n.h2,{id:"convert-the-document-signer-certificate-to-a-cer-file",children:"Convert the Document Signer Certificate to a CER file"}),"\n",(0,s.jsx)(n.p,{children:"openssl x509 -in dsc.pem -outform DER -out dsc.cer"}),"\n",(0,s.jsx)(n.h2,{id:"get-the-cscas",children:"Get the CSCA's"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Download the Masterlist file here ",(0,s.jsx)(n.a,{href:"https://www.npkd.nl/index.html",children:"https://www.npkd.nl/index.html"})]}),"\n",(0,s.jsx)(n.li,{children:"Download the Self-signed certificate and link certificate"}),"\n",(0,s.jsxs)(n.li,{children:["Use the ",(0,s.jsx)(n.a,{href:"https://github.com/DibranMulder/icao-ml-tools",children:"icao-ml-tools"})," to unpack the Masterlist"]}),"\n",(0,s.jsxs)(n.li,{children:["Look for the right serial number which is in the ",(0,s.jsx)(n.code,{children:"EF.SOD"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"openssl asn1parse -in EF.SOD -inform DER -i"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Convert the CSCA ",(0,s.jsx)(n.code,{children:"der"})," file to a ",(0,s.jsx)(n.code,{children:"cer"})," file.","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"openssl x509 -in input.der -inform DER -out output.cer -outform PEM"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h1,{id:"verify-dsc-chain",children:"Verify DSC chain"}),"\n",(0,s.jsx)(n.p,{children:"Verify that the Document Signer Certificate belongs to the CSCA."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"openssl verify -CAfile csca.cer dsc.pem\r\ndsc.pem: OK\n"})}),"\n",(0,s.jsx)(n.h2,{id:"extract-signed-content",children:"Extract signed content"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"openssl cms -inform DER -in EF.SOD.cms -verify -noverify -out lds_content.der\n"})}),"\n",(0,s.jsx)(n.h2,{id:"verify-efsod-signature",children:"Verify EF.SOD signature"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"openssl cms -inform DER -in EF.SOD.cms -CAfile csca.cer -out /dev/null -verify\r\nCMS Verification successful\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}}}]);